"""
GPT í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ
ë™ì ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ê´€ë¦¬í•˜ê³  ì‹œì¥ ìƒí™©ì— ë§ê²Œ ìë™ ì—…ë°ì´íŠ¸í•˜ëŠ” ì‹œìŠ¤í…œ
"""

import json
import os
from datetime import datetime
from typing import Dict, Any, Optional
from dataclasses import dataclass, asdict
import yaml


@dataclass
class MarketContext:
    """í˜„ì¬ ì‹œì¥ ìƒí™©ì„ ë‚˜íƒ€ë‚´ëŠ” ë°ì´í„° í´ë˜ìŠ¤"""
    current_date: str
    market_phase: str  # 'recovery', 'stable', 'recession', 'growth'
    key_concerns: list
    scenario_probabilities: Dict[str, float]
    industry_trends: list


class PromptManager:
    """GPT í”„ë¡¬í”„íŠ¸ë¥¼ ë™ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” í´ë˜ìŠ¤"""
    
    def __init__(self, prompts_dir: str = "config/prompts"):
        self.prompts_dir = prompts_dir
        self.market_context = self._get_current_market_context()
        self._ensure_prompts_directory()
        self._initialize_default_prompts()
    
    def _ensure_prompts_directory(self):
        """í”„ë¡¬í”„íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±"""
        if not os.path.exists(self.prompts_dir):
            os.makedirs(self.prompts_dir)
    
    def _get_current_market_context(self) -> MarketContext:
        """í˜„ì¬ ì‹œì¥ ìƒí™©ì„ ë¶„ì„í•˜ì—¬ ì»¨í…ìŠ¤íŠ¸ ìƒì„±"""
        current_date = datetime.now().strftime("%Yë…„ %mì›” %dì¼")
        
        # 2025ë…„ ê¸°ì¤€ ì‹œì¥ ìƒí™© ë¶„ì„
        if datetime.now().year == 2025:
            market_phase = "recovery"  # ì½”ë¡œë‚˜ ì´í›„ íšŒë³µì„¸
            key_concerns = [
                "ê¸€ë¡œë²Œ ê²½ê¸°ì¹¨ì²´ ì˜í–¥",
                "ìœ ê°€ë³€ë™",
                "í™˜ìœ¨ë¦¬ìŠ¤í¬", 
                "ê²½ìŸì‹¬í™”",
                "íƒ„ì†Œì¤‘ë¦½ ê·œì œ",
                "ê¸ˆë¦¬í™˜ê²½",
                "AI/ë””ì§€í„¸í™”"
            ]
            scenario_probabilities = {
                "optimistic": 0.30,  # ê¸€ë¡œë²Œ ê²½ê¸° íšŒë³µì„¸
                "baseline": 0.50,    # ì•ˆì •ì  ì„±ì¥ì„¸ ì§€ì†
                "pessimistic": 0.20  # ê¸€ë¡œë²Œ ê²½ê¸°ì¹¨ì²´ ì‹¬í™”
            }
            industry_trends = [
                "í•­ê³µì—…ê³„ ë””ì§€í„¸ ì „í™˜ ê°€ì†í™”",
                "ì¹œí™˜ê²½ í•­ê³µê¸° ë„ì… í™•ëŒ€",
                "ì €ë¹„ìš© í•­ê³µì‚¬ ì‹œì¥ ì ìœ ìœ¨ ì¦ê°€",
                "êµ­ì œì„  ìˆ˜ìš” íšŒë³µì„¸ ì§€ì†"
            ]
        else:
            # ê¸°ë³¸ê°’ (ë¯¸ë˜ ì‹œì¥ ìƒí™©ì— ëŒ€ë¹„)
            market_phase = "stable"
            key_concerns = [
                "ê²½ì œ ë¶ˆí™•ì‹¤ì„±",
                "ìœ ê°€ë³€ë™",
                "í™˜ìœ¨ë¦¬ìŠ¤í¬",
                "ê·œì œ ë³€í™”"
            ]
            scenario_probabilities = {
                "optimistic": 0.25,
                "baseline": 0.50,
                "pessimistic": 0.25
            }
            industry_trends = [
                "ì—…ê³„ ë””ì§€í„¸í™”",
                "ì¹œí™˜ê²½ ì •ì±… ëŒ€ì‘",
                "ê²½ìŸ ì‹¬í™”"
            ]
        
        return MarketContext(
            current_date=current_date,
            market_phase=market_phase,
            key_concerns=key_concerns,
            scenario_probabilities=scenario_probabilities,
            industry_trends=industry_trends
        )
    
    def _initialize_default_prompts(self):
        """ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ íŒŒì¼ë“¤ì„ ìƒì„±"""
        self._create_system_prompts()
        self._create_user_prompts()
        self._create_market_context_file()
    
    def _create_system_prompts(self):
        """ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ íŒŒì¼ ìƒì„±"""
        system_prompts = {
            "credit_analysis": {
                "role": "system",
                "content_template": "ë‹¹ì‹ ì€ í•œêµ­ ì‹œì¤‘ì€í–‰ì˜ ê¸°ì—…ê¸ˆìœµ ëŒ€ì¶œì‹¬ì‚¬ ì „ë¬¸ê°€ë¡œì„œ 20ë…„ ê²½ë ¥ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤. í•­ê³µì—…ê³„ ì—¬ì‹ ì—…ë¬´ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•©ë‹ˆë‹¤. í˜„ì¬ ë‚ ì§œëŠ” {current_date}ì…ë‹ˆë‹¤. ëª¨ë“  ë¶„ì„ê³¼ ê¶Œê³ ì‚¬í•­ì€ í˜„ì¬ ì‹œì ({current_date})ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."
            },
            "comprehensive_report": {
                "role": "system", 
                "content_template": "ë‹¹ì‹ ì€ í•œêµ­ ì‹œì¤‘ì€í–‰ì˜ ê¸°ì—…ê¸ˆìœµíŒ€ì¥ìœ¼ë¡œì„œ 20ë…„ ê²½ë ¥ì˜ í•­ê³µì—…ê³„ ì—¬ì‹  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì‹¤ë¬´ì§„ê³¼ ê²½ì˜ì§„ì´ ëª¨ë‘ ë‚©ë“í•  ìˆ˜ ìˆëŠ” ì¢…í•©ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. í˜„ì¬ ë‚ ì§œëŠ” {current_date}ì…ë‹ˆë‹¤. ëª¨ë“  ë¶„ì„ê³¼ ê¶Œê³ ì‚¬í•­ì€ í˜„ì¬ ì‹œì ({current_date})ì„ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."
            }
        }
        
        filepath = os.path.join(self.prompts_dir, "system_prompts.json")
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(system_prompts, f, ensure_ascii=False, indent=2)
    
    def _create_user_prompts(self):
        """ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ íŒŒì¼ ìƒì„±"""
        user_prompts = {
            "credit_analysis": {
                "template": """
ë‹¹ì‹ ì€ í•œêµ­ì˜ ì‹œì¤‘ì€í–‰ì—ì„œ 20ë…„ ê²½ë ¥ì„ ê°€ì§„ ê¸°ì—…ê¸ˆìœµ ëŒ€ì¶œì‹¬ì‚¬ íŒ€ì¥ì…ë‹ˆë‹¤. 
í•­ê³µì—…ê³„ ëŒ€ì¶œì‹¬ì‚¬ì™€ ê¸°ì—…ì—¬ì‹  ê´€ë¦¬ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ë©°, ì•„ë˜ ì‹ ìš©ìœ„í—˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ 
ëŒ€ì¶œë‹´ë‹¹ ì§ì›ë“¤ì´ ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ìƒì„¸í•œ ì—¬ì‹ ì‹¬ì‚¬ ë ˆí¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë¶„ì„ ìš”ì²­: {prompt}

ëŒ€ì‹œë³´ë“œ í‘œì‹œ ë°ì´í„° (ì „ì²´):
{context_data}

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì—¬ì‹ ì‹¬ì‚¬ ê´€ì ì˜ ë ˆí¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

## ğŸ¦ ì—¬ì‹ ì‹¬ì‚¬ ì¢…í•©ì˜ê²¬
- ëŒ€ì¶œì‹¤í–‰ ê´€ë ¨ í•µì‹¬ íŒë‹¨ì‚¬í•­ (ìŠ¹ì¸/ë³´ë¥˜/ê±°ì ˆ ê¶Œê³ )
- ì‹ ìš©ë“±ê¸‰ ë³€ë™ ê°€ëŠ¥ì„±ì— ë”°ë¥¸ ì—¬ì‹ ë¦¬ìŠ¤í¬ í‰ê°€
- ë‹´ë³´ ë° ë³´ì¦ ìš”êµ¬ì‚¬í•­ ê²€í†  í•„ìš”ì„±

## ğŸ“Š ì¬ë¬´ê±´ì „ì„± ë¶„ì„
- ê° í•­ê³µì‚¬ë³„ ì‹ ìš©ë„ ìƒì„¸ í‰ê°€ (ë“±ê¸‰ë³„ ì°¨ë“± ë¶„ì„)
- ë‹¨ê¸°/ì¤‘ê¸°/ì¥ê¸° ì‹œê³„ì—´ ìœ„í—˜ë„ ë³€í™” ì¶”ì´ ë¶„ì„
- ì—…ê³„ ë‚´ ìƒëŒ€ì  ì‹ ìš©ìœ„í—˜ ìˆœìœ„ ë° ë²¤ì¹˜ë§ˆí‚¹
- ì¬ë¬´ë¹„ìœ¨ ê¸°ë°˜ ìƒí™˜ëŠ¥ë ¥ í‰ê°€

## âš ï¸ ì—¬ì‹ ê´€ë¦¬ ì£¼ì˜ì‚¬í•­
- ì¦‰ì‹œ ì—¬ì‹ í•œë„ ì¡°ì •ì´ í•„ìš”í•œ ê±°ë˜ì²˜ ì‹ë³„
- ë‹´ë³´ì¸ì •ë¹„ìœ¨(LTV) ì¡°ì • ê²€í†  ëŒ€ìƒ
- ì¶”ê°€ ë‹´ë³´ì œê³µ ìš”êµ¬ ë˜ëŠ” ë³´ì¦ì¸ í™•ë³´ í•„ìš” ê¸°ì—…
- ì—¬ì‹ íšŒìˆ˜ ë° ì¶œêµ¬ì „ëµ ì¤€ë¹„ê°€ í•„ìš”í•œ ê³ ìœ„í—˜ ê±°ë˜ì²˜

## ğŸ¯ ëŒ€ì¶œì‹¬ì‚¬ ì‹¤í–‰ë°©ì•ˆ
- ì‹ ê·œ ëŒ€ì¶œì‹ ì²­ì‹œ ì‹¬ì‚¬ í¬ì¸íŠ¸ ë° ìŠ¹ì¸ì¡°ê±´
- ê¸°ì¡´ ì—¬ì‹ ì˜ ì—°ì¥/ê°±ì‹ ì‹œ ê³ ë ¤ì‚¬í•­
- ê¸ˆë¦¬ ì°¨ë“±ì ìš© ë° ìˆ˜ìˆ˜ë£Œ ì¡°ì • ë°©í–¥
- ì—¬ì‹ ì•½ì •ì„œ íŠ¹ì•½ì¡°í•­ ì¶”ê°€ ê²€í† ì‚¬í•­
- ì‚¬í›„ê´€ë¦¬ ëª¨ë‹ˆí„°ë§ ì£¼ê¸° ë° ì ê²€ í•­ëª©

## ğŸ“ˆ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ ì „ëµ
- í•­ê³µì—…ê³„ ì—¬ì‹  í¬íŠ¸í´ë¦¬ì˜¤ì˜ ìœ„í—˜ë¶„ì‚° í˜„í™© í‰ê°€
- ì—…ì¢… ì§‘ì¤‘ë„ ë¦¬ìŠ¤í¬ ë° ë¶„ì‚°íˆ¬ì í•„ìš”ì„±
- ê²½ê¸°ë³€ë™ ë° ìœ ê°€ë³€ë™ì— ë”°ë¥¸ ì‹œë‚˜ë¦¬ì˜¤ë³„ ëŒ€ì‘ë°©ì•ˆ
- ê·œì œë‹¹êµ­ ê±´ì „ì„± ì§€í‘œ ê´€ë¦¬ ê´€ì ì˜ ê¶Œê³ ì‚¬í•­

ì€í–‰ ì‹¤ë¬´ì§„ì´ ì¦‰ì‹œ í™œìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜, ë¹„ìœ¨, ì„ê³„ê°’ì„ ëª…ì‹œí•˜ê³ , 
ì—¬ì‹ ê·œì •ê³¼ ë¦¬ìŠ¤í¬ê´€ë¦¬ ê¸°ì¤€ì— ë¶€í•©í•˜ëŠ” ì‹¤ë¬´ì  íŒë‹¨ê·¼ê±°ë¥¼ ìƒì„¸íˆ ì œì‹œí•´ì£¼ì„¸ìš”.
ê³¼ë„í•œ ìš”ì•½ë³´ë‹¤ëŠ” ì¶©ë¶„í•œ ì„¤ëª…ê³¼ ê·¼ê±°ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.
"""
            },
            "comprehensive_report": {
                "template": """
í•œêµ­ ì‹œì¤‘ì€í–‰ì˜ ê¸°ì—…ê¸ˆìœµíŒ€ì¥ìœ¼ë¡œì„œ, í•­ê³µì—…ê³„ ì „ë¬¸ ëŒ€ì¶œì‹¬ì‚¬ìœ„ì›íšŒì— ì œì¶œí•  ì¢…í•© ì‹ ìš©ìœ„í—˜ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ğŸ“Š í˜„ì¬ ë°ì´í„° í˜„í™©
- **ë¶„ì„ ëŒ€ìƒ**: í•œêµ­ í•­ê³µì—…ê³„ ì„ ë³„ {company_count}ê°œ ê¸°ì—… ({company_names})
- **ë¶„ì„ ê¸°ì¤€ì¼**: {current_date}
- **ìœ„í—˜ë„ ì¸¡ì •**: 90ì¼ ì‹ ìš©ë“±ê¸‰ ë³€ë™ í™•ë¥  ê¸°ì¤€
- **í‰ê·  90ì¼ ìœ„í—˜ë„**: {avg_risk:.3%}
- **ê³ ìœ„í—˜ ê¸°ì—… ìˆ˜**: {high_risk_count}ê°œ (ì„ê³„ê°’ {risk_threshold:.1%} ì´ˆê³¼)
- **ìµœê³  ìœ„í—˜ ê¸°ì—…**: {max_risk_company} ({max_risk_value:.3%})
- **ìµœì € ìœ„í—˜ ê¸°ì—…**: {min_risk_company} ({min_risk_value:.3%})
- **í¬íŠ¸í´ë¦¬ì˜¤ ìœ„í—˜ë¶„ì‚°ë„**: í‘œì¤€í¸ì°¨ {risk_std:.3%}

## ğŸ’¼ ê¸°ì—…ë³„ ìƒì„¸ ì •ë³´
{detailed_firm_info}

## ğŸ“ˆ ì£¼ìš” ë°œê²¬ì‚¬í•­ ë° ì‹œì¥ ë™í–¥

### ğŸ”º ì—…ê·¸ë ˆì´ë“œ í›„ë³´ ê¸°ì—… (ë“±ê¸‰ ê°œì„  ê°€ëŠ¥ì„±):
{upgrade_candidates_info}

### ğŸ”» ë‹¤ìš´ê·¸ë ˆì´ë“œ ìœ„í—˜ ê¸°ì—… (ë“±ê¸‰ ì•…í™” ìš°ë ¤):
{downgrade_risks_info}

### ğŸ“Š í¬íŠ¸í´ë¦¬ì˜¤ ìœ„í—˜ ë¶„í¬:
- ìœ„í—˜ë„ 1ì‚¬ë¶„ìœ„: {risk_q25:.3%}
- ìœ„í—˜ë„ 2ì‚¬ë¶„ìœ„(ì¤‘ìœ„ê°’): {risk_q50:.3%}
- ìœ„í—˜ë„ 3ì‚¬ë¶„ìœ„: {risk_q75:.3%}

### âš ï¸ ìµœê·¼ ì•Œë¦¼ ì´ë ¥ ë° ëª¨ë‹ˆí„°ë§ í˜„í™©:
{recent_alerts_info}

## ğŸ“‹ ì¢…í•© ë¶„ì„ ë¦¬í¬íŠ¸ ìš”ì²­ì‚¬í•­

ë‹¤ìŒ êµ¬ì¡°ë¡œ **ìƒì„¸í•œ ì¢…í•© ë¶„ì„ ë¦¬í¬íŠ¸**ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

### 1. ğŸ¯ **í•µì‹¬ ìš”ì•½** (Executive Summary)
- ì„ ë³„ ë¶„ì„í•œ í•­ê³µì—…ê³„ {company_count}ê°œ ê¸°ì—…ì˜ ì „ë°˜ì  ì‹ ìš©ìœ„í—˜ í˜„í™©
- í¬íŠ¸í´ë¦¬ì˜¤ ì „ì²´ ìœ„í—˜ë„ ìˆ˜ì¤€ ë° ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸
- í–¥í›„ 3ê°œì›”ê°„ ì˜ˆìƒë˜ëŠ” ì‹ ìš©ë“±ê¸‰ ë³€ë™ ë™í–¥
- ëŒ€ì¶œì‹¬ì‚¬ìœ„ì›íšŒ ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í•µì‹¬ ê¶Œê³ ì‚¬í•­

### 2. ğŸ“Š **ì—…ê³„ë³„ ìƒì„¸ ë¶„ì„**
- **í•­ê³µì—…ê³„ ì „ë°˜ì  ë™í–¥**: {current_date} ê¸°ì¤€ ì‹œì¥ ìƒí™©
- **ì—…ê³„ íŠ¹ì„±ì„ ê³ ë ¤í•œ ì£¼ìš” ìš°ë ¤ì‚¬í•­ 5ê°€ì§€**: {key_concerns_str}
- **ê²½ìŸì‚¬ ëŒ€ë¹„ ìƒëŒ€ì  ì‹ ìš©ë„**: ì—…ê³„ ë‚´ ìˆœìœ„ ë° ë²¤ì¹˜ë§ˆí‚¹
- **ì—…ì¢…ë³„ ë¦¬ìŠ¤í¬ ìš”ì¸ë³„ ì˜í–¥ë„ ë¶„ì„**:
  - **ê¸€ë¡œë²Œ ê²½ê¸°ì¹¨ì²´ ì˜í–¥**: êµ­ë‚´ì„ /êµ­ì œì„  ìˆ˜ìš” ë³€í™”, ì†Œë¹„ì ì—¬í–‰ íŒ¨í„´ ë³€í™”
  - **ìœ ê°€ë³€ë™**: ì—°ë£Œë¹„ ë¹„ì¤‘ ë° ìˆ˜ìµì„±ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
  - **í™˜ìœ¨ë¦¬ìŠ¤í¬**: ë‹¬ëŸ¬í™” ê°•ì„¸ê°€ í•­ê³µì‚¬ ìˆ˜ìµì„±ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
  - **ê²½ìŸì‹¬í™”**: ì €ë¹„ìš©í•­ê³µì‚¬ ë“±ì¥ê³¼ ê¸°ì¡´ í•­ê³µì‚¬ ê²½ìŸë ¥ ë³€í™”
  - **íƒ„ì†Œì¤‘ë¦½ ê·œì œ**: ì¹œí™˜ê²½ í•­ê³µê¸° ë„ì… ë¹„ìš© ë° ê·œì œ ëŒ€ì‘ í˜„í™©
  - **ê¸ˆë¦¬í™˜ê²½**: ê³ ê¸ˆë¦¬ ê¸°ì¡°ê°€ í•­ê³µì‚¬ ë¶€ì±„ë¶€ë‹´ì— ë¯¸ì¹˜ëŠ” ì˜í–¥
  - **AI/ë””ì§€í„¸í™”**: í•­ê³µì—…ê³„ ë””ì§€í„¸ ì „í™˜ê³¼ ìš´ì˜ íš¨ìœ¨ì„± ê°œì„ 

### 3. ğŸ¢ **ê¸°ì—…ë³„ ì‹ ìš©ë„ í‰ê°€ ë° ë“±ê¸‰ ì „ë§**
- **ê°œë³„ ê¸°ì—… ìƒì„¸ ë¶„ì„**: ê° ê¸°ì—…ë³„ ì‹ ìš©ë“±ê¸‰ ë³€ë™ ìš”ì¸ ë¶„ì„
- **ë“±ê¸‰ë³„ ê·¸ë£¹í•‘**: AAA~D ë“±ê¸‰ë³„ ê¸°ì—… ë¶„í¬ ë° íŠ¹ì„±
- **ë“±ê¸‰ ë³€ë™ ì˜ˆì¸¡**: í–¥í›„ 3ê°œì›”ê°„ ë“±ê¸‰ ìƒí–¥/í•˜í–¥ ì „ë§
- **ë“±ê¸‰ë³„ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ì•ˆ**: ë“±ê¸‰ë³„ ì°¨ë“±í™”ëœ ì—¬ì‹  ê´€ë¦¬ ì „ëµ

### 4. âš ï¸ **ì—¬ì‹ ê´€ë¦¬ ì‹¤í–‰ê³„íš**

**A. ê³ ìœ„í—˜ ê¸°ì—… ê´€ë¦¬:**
- [ ] {max_risk_company} ë“± ê³ ìœ„í—˜ {high_risk_count}ê°œì‚¬ ëŒ€ìƒ ì›”ê°„ ì¬ë¬´ì œí‘œ ì œì¶œ ì˜ë¬´í™”
- [ ] ì‹ ìš©ë“±ê¸‰ í•˜ë½ì‹œ ìë™ ì—¬ì‹ í•œë„ ì¶•ì†Œ ì¥ì¹˜ ì„¤ì •
- [ ] ë¶€ë„ìœ„í—˜ ê¸°ì—… ëŒ€ìƒ ë³´ì¦ë³´í—˜ ê°€ì… ê²€í† 

**B. í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬:**
- [ ] í•­ê³µì—…ì¢… ì—¬ì‹  ì§‘ì¤‘ë„ í•œë„ ì¬ì„¤ì • (í˜„ì¬ ì§‘ì¤‘ë„ ê²€í† )
- [ ] ì—…ì¢… ë‚´ ìœ„í—˜ë¶„ì‚°ì„ ìœ„í•œ ìš°ëŸ‰ ê¸°ì—… ì—¬ì‹  í™•ëŒ€ ê²€í† 
- [ ] ìœ ê°€í—¤ì§€ ë“± ë¦¬ìŠ¤í¬ ì™„í™” ìƒí’ˆ í™œìš© ì˜ë¬´í™” ê²€í† 
- [ ] ê³„ì ˆì„± ìš”ì¸ì„ ê³ ë ¤í•œ ìœ ë™ì„± ê³µê¸‰ ê³„íš ìˆ˜ë¦½

**C. ëª¨ë‹ˆí„°ë§ ì²´ê³„:**
- [ ] ì‹¤ì‹œê°„ ì‹ ìš©ìœ„í—˜ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•
- [ ] ì›”ê°„ í•­ê³µì—…ê³„ ë™í–¥ ë³´ê³ ì„œ ì‘ì„± ì²´ê³„ í™•ë¦½
- [ ] ìœ ê°€/í™˜ìœ¨ ë³€ë™ì‹œ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ì •ê¸° ì‹¤ì‹œ
- [ ] ê²½ìŸì‚¬ ëŒ€ë¹„ ìƒëŒ€ì  ì‹ ìš©ë„ ë³€í™” ì¶”ì  ì‹œìŠ¤í…œ ë„ì…

### 5. ğŸ² **í–¥í›„ 3ê°œì›” ì‹œë‚˜ë¦¬ì˜¤ë³„ ì˜ˆì¸¡ ë° ëŒ€ì‘ë°©ì•ˆ**

**ğŸŸ¢ ë‚™ê´€ ì‹œë‚˜ë¦¬ì˜¤ (í™•ë¥  {optimistic_prob:.0%}): ê¸€ë¡œë²Œ ê²½ê¸° íšŒë³µì„¸**
- ìœ„í—˜ë„ ê°œì„  ì˜ˆìƒ ê¸°ì—…: [êµ¬ì²´ì  ê¸°ì—…ëª…ê³¼ ê°œì„ í­ ì œì‹œ]
- ì—¬ì‹  í™•ëŒ€ ê²€í†  ëŒ€ìƒ ë° ì‹ ê·œ ì—¬ì‹  ê¸°íšŒ
- ê¸ˆë¦¬ ì¸í•˜ í˜œíƒ ì ìš© ê¸°ì—… ì„ ë³„

**ğŸŸ¡ ê¸°ë³¸ ì‹œë‚˜ë¦¬ì˜¤ (í™•ë¥  {baseline_prob:.0%}): ì•ˆì •ì  ì„±ì¥ì„¸ ì§€ì†**
- í˜„ìƒ ìœ ì§€ ì˜ˆìƒ ê¸°ì—…ë“¤ì˜ ì•ˆì •ì  ê´€ë¦¬ ë°©ì•ˆ
- ê¸°ì¡´ ì—¬ì‹ ì¡°ê±´ ìœ ì§€í•˜ë˜ ëª¨ë‹ˆí„°ë§ ê°•í™”
- ë¶„ê¸°ë³„ ì¬í‰ê°€ë¥¼ í†µí•œ ì¡°ê±´ ì¡°ì • ê²€í† 

**ğŸ”´ ë¹„ê´€ ì‹œë‚˜ë¦¬ì˜¤ (í™•ë¥  {pessimistic_prob:.0%}): ê¸€ë¡œë²Œ ê²½ê¸°ì¹¨ì²´ ì‹¬í™”**
- ìœ„í—˜ë„ ê¸‰ì† ì•…í™” ìš°ë ¤ ê¸°ì—… ë° ì„ ì œì  ëŒ€ì‘ì±…
- ì—¬ì‹ íšŒìˆ˜ ë° êµ¬ì¡°ì¡°ì • ì§€ì› ë°©ì•ˆ
- ì •ë¶€ ì§€ì›ì •ì±… ì—°ê³„ë¥¼ í†µí•œ ì†ì‹¤ ìµœì†Œí™” ì „ëµ

### 6. ğŸ’¡ **ì¢…í•© ë¦¬ìŠ¤í¬ ì™„í™” ì „ëµ**

**A. í¬íŠ¸í´ë¦¬ì˜¤ ë‹¤ê°í™”:**
- í•­ê³µì—…ì¢… ë‚´ ì„¸ë¶€ ì—…ì¢…ë³„ ë¶„ì‚° (ëŒ€í˜•í•­ê³µì‚¬ vs ì €ë¹„ìš©í•­ê³µì‚¬)
- ì§€ì—­ë³„ ë…¸ì„  íŠ¹ì„±ì„ ê³ ë ¤í•œ ìœ„í—˜ë¶„ì‚° (êµ­ë‚´ì„  vs êµ­ì œì„ )
- í•­ê³µê¸° ë¦¬ìŠ¤ vs ìš´í•­ ì „ë¬¸ ê¸°ì—… ê°„ ìœ„í—˜ë¶„ì‚°

**B. í—¤ì§€ìƒí’ˆ ë° ë³´í—˜ í™œìš©:**
- ìœ ê°€ì—°ë™ íŒŒìƒìƒí’ˆì„ í†µí•œ ì—°ë£Œë¹„ í—¤ì§€ ì˜ë¬´í™”
- ì‹ ìš©ë³´ì¦ê¸°ê¸ˆ/ê¸°ìˆ ë³´ì¦ê¸°ê¸ˆ ì—°ê³„ ë³´ì¦ í™•ëŒ€
- ë¬´ì—­ë³´í—˜ê³µì‚¬ í•´ì™¸íˆ¬ìë³´í—˜ ë“± ì •ì±…ë³´í—˜ í™œìš©

**C. ì—…ê³„ ì „ë¬¸ ëª¨ë‹ˆí„°ë§ ì²´ê³„:**
- í•­ê³µêµí†µëŸ‰, ìœ ê°€ì§€ìˆ˜, í™˜ìœ¨ ë“± í•µì‹¬ì§€í‘œ ì‹¤ì‹œê°„ ì¶”ì 
- êµ­ì œí•­ê³µìš´ì†¡í˜‘íšŒ(IATA) ë“± ê¸€ë¡œë²Œ ë™í–¥ ë¶„ì„ ì²´ê³„
- ë™ì¢…ì—…ê³„ íƒ€í–‰ ì—¬ì‹ ë™í–¥ ë° ë¶€ì‹¤ë¥  ë²¤ì¹˜ë§ˆí‚¹
- ì •ê¸°ì ì¸ í•­ê³µì—…ê³„ ì „ë¬¸ê°€ ìë¬¸íšŒì˜ ìš´ì˜

### 7. ğŸ¦ **ì€í–‰ ë‚´ë¶€ ê´€ë¦¬ ë°©ì•ˆ**
- ì—¬ì‹ ì‹¬ì‚¬ì—­ ëŒ€ìƒ í•­ê³µì—…ê³„ ì „ë¬¸êµìœ¡ ì‹¤ì‹œ
- ë¦¬ìŠ¤í¬ê´€ë¦¬ ì‹œìŠ¤í…œ ë‚´ í•­ê³µì—…ì¢… íŠ¹í™” ëª¨ë¸ êµ¬ì¶•
- ê°ë…ë‹¹êµ­ ë³´ê³ ìš© ì—…ì¢…ë³„ ê±´ì „ì„± ì§€í‘œ ê´€ë¦¬ ì²´ê³„
- ì´ì‚¬íšŒ ë³´ê³ ìš© ë¶„ê¸°ë³„ ì—…ì¢… ë¦¬ìŠ¤í¬ í˜„í™© ë³´ê³ ì„œ ì–‘ì‹ í‘œì¤€í™”

**ì‘ì„±ì‹œ ì£¼ì˜ì‚¬í•­:**
1. ëª¨ë“  ìˆ˜ì¹˜ëŠ” ì†Œìˆ˜ì  3ìë¦¬ê¹Œì§€ ì •í™•íˆ ì œì‹œ
2. êµ¬ì²´ì  ê¸°ì—…ëª…ê³¼ í•¨ê»˜ ì‹¤í–‰ ê°€ëŠ¥í•œ ê¶Œê³ ì‚¬í•­ ëª…ì‹œ
3. ì€í–‰ ë‚´ë¶€ ìŠ¹ì¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ê³ ë ¤í•œ ì‹¤ë¬´ì  ê´€ì  ë°˜ì˜
4. ê° ì„¹ì…˜ì„ ì¶©ë¶„í•œ ë¶„ëŸ‰ìœ¼ë¡œ ìƒì„¸íˆ ì‘ì„± (ìš”ì•½ë³´ë‹¤ëŠ” êµ¬ì²´ì  ì„¤ëª… ì¤‘ì‹¬)
5. í‘œ, ë¦¬ìŠ¤íŠ¸, ì²´í¬ë°•ìŠ¤ë¥¼ ì ê·¹ í™œìš©í•˜ì—¬ ê°€ë…ì„± í™•ë³´
6. ì •ëŸ‰ì  ë¶„ì„ê³¼ ì •ì„±ì  íŒë‹¨ì„ ê· í˜•ìˆê²Œ í¬í•¨
7. ì‹œì¥ ìƒí™© ë³€í™”ì— ë”°ë¥¸ ë™ì  ëŒ€ì‘ ë°©ì•ˆ í¬í•¨

ì´ ë¦¬í¬íŠ¸ëŠ” ëŒ€ì¶œì‹¬ì‚¬ìœ„ì›íšŒì—ì„œ ì¦‰ì‹œ ì˜ì‚¬ê²°ì •ì— í™œìš©ë  ì˜ˆì •ì´ë¯€ë¡œ, ì‹¤ë¬´ì§„ê³¼ ê²½ì˜ì§„ ëª¨ë‘ê°€ ë‚©ë“í•  ìˆ˜ ìˆëŠ” ì¢…í•©ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë¶„ì„ ë¦¬í¬íŠ¸ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
"""
            }
        }
        
        filepath = os.path.join(self.prompts_dir, "user_prompts.json")
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(user_prompts, f, ensure_ascii=False, indent=2)
    
    def _create_market_context_file(self):
        """ì‹œì¥ ì»¨í…ìŠ¤íŠ¸ íŒŒì¼ ìƒì„±"""
        filepath = os.path.join(self.prompts_dir, "market_context.yaml")
        with open(filepath, 'w', encoding='utf-8') as f:
            yaml.dump(asdict(self.market_context), f, default_flow_style=False, allow_unicode=True)
    
    def get_system_prompt(self, prompt_type: str) -> Dict[str, str]:
        """ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°"""
        filepath = os.path.join(self.prompts_dir, "system_prompts.json")
        with open(filepath, 'r', encoding='utf-8') as f:
            prompts = json.load(f)
        
        if prompt_type not in prompts:
            raise ValueError(f"Unknown prompt type: {prompt_type}")
        
        prompt_data = prompts[prompt_type]
        return {
            "role": prompt_data["role"],
            "content": prompt_data["content_template"].format(
                current_date=self.market_context.current_date
            )
        }
    
    def get_user_prompt(self, prompt_type: str, **kwargs) -> str:
        """ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°"""
        filepath = os.path.join(self.prompts_dir, "user_prompts.json")
        with open(filepath, 'r', encoding='utf-8') as f:
            prompts = json.load(f)
        
        if prompt_type not in prompts:
            raise ValueError(f"Unknown prompt type: {prompt_type}")
        
        template = prompts[prompt_type]["template"]
        
        # ê¸°ë³¸ê°’ ì„¤ì •
        default_kwargs = {
            "current_date": self.market_context.current_date,
            "key_concerns_str": ", ".join(self.market_context.key_concerns),
            "optimistic_prob": self.market_context.scenario_probabilities["optimistic"],
            "baseline_prob": self.market_context.scenario_probabilities["baseline"],
            "pessimistic_prob": self.market_context.scenario_probabilities["pessimistic"],
        }
        
        # ì‚¬ìš©ì ì œê³µ kwargsë¡œ ê¸°ë³¸ê°’ ë®ì–´ì“°ê¸°
        default_kwargs.update(kwargs)
        
        return template.format(**default_kwargs)
    
    def update_market_context(self):
        """ì‹œì¥ ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸"""
        self.market_context = self._get_current_market_context()
        self._create_market_context_file()
    
    def get_prompt_info(self) -> Dict[str, Any]:
        """í˜„ì¬ í”„ë¡¬í”„íŠ¸ ì‹œìŠ¤í…œ ì •ë³´ ë°˜í™˜"""
        return {
            "prompts_directory": self.prompts_dir,
            "market_context": asdict(self.market_context),
            "available_prompt_types": ["credit_analysis", "comprehensive_report"],
            "last_updated": datetime.now().isoformat()
        }


# ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤
_prompt_manager = None

def get_prompt_manager() -> PromptManager:
    """í”„ë¡¬í”„íŠ¸ ë§¤ë‹ˆì € ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜"""
    global _prompt_manager
    if _prompt_manager is None:
        _prompt_manager = PromptManager()
    return _prompt_manager 